name: Build Xamarin.Android app

on: [push]

jobs:
  build-android:
    runs-on: macos-latest
    env: 
      APP_NAME: Inspector.Android
      SLN_FILE_PATH: './src/Inspector.sln'
      CSPROJ_FILE_PATH: './src/Inspector.Android/Inspector.Android.csproj'
      BUILD_CONFIGURATION: Debug-Agent
      ANDROID_BUILD_APK: x_do.gob.ogtic.inspector.apk
      MONO_VERSION: '6.10'
      ANDROID_VERSION: '11.1'

    steps:
    - uses: actions/checkout@v2
      with:
        submodules: 'recursive'
        token: ${{ secrets.OGTIC_PAT }}

    - name: Set default Xamarin SDK versions
      run: |
        $VM_ASSETS/select-xamarin-sdk-v2.sh --mono=${{ env.MONO_VERSION }} --android=${{ env.ANDROID_VERSION }}

    - uses: actions/setup-dotnet@v1
      with:
        dotnet-version: '3.1.x'

    - name: NuGet restore and Build
      run: |
        nuget restore ${{ env.SLN_FILE_PATH }}
        msbuild /t:PackageForAndroid /p:Configuration=${{ env.BUILD_CONFIGURATION }} /p:UseSharedCompilation=false ${{ env.CSPROJ_FILE_PATH }}

    - run: |
        nuget restore ${{ env.SLN_FILE_PATH }}
        msbuild /t:PackageForAndroid /p:Configuration=${{ env.BUILD_CONFIGURATION }} /p:UseSharedCompilation=false ${{ env.CSPROJ_FILE_PATH }}

    - uses: actions/upload-artifact@v2
      with:
        name: android-apk
        if-no-files-found: error
        path: "**/bin/${{ env.BUILD_CONFIGURATION }}/${{ env.ANDROID_BUILD_APK }}"

  distribute:
    runs-on: ubuntu-latest
    needs: [ build-android ]

    steps:
    - uses: actions/download-artifact@v2
      with:
        name: android-apk

    - name: App Center
      uses: wzieba/AppCenter-Github-Action@v1.0.0
      with:
        appName: gobdo/Reportero Ciudadano - Droid
        token: ${{ secrets.APP_CENTER_TOKEN }}
        group: Internal
        # Artefact to upload (.apk or .ipa)
        file: Inspector/${{ env.APP_NAME }}/bin/${{ env.BUILD_CONFIGURATION }}/${{ env.ANDROID_BUILD_APK }}
        # Release notes visible on release page
        releaseNotes: "demo test"