name: Build Xamarin app

on:
  push:
    branches:
      - "main"
      - "staging"
      - "testing"
      - "github-action"
  pull_request:
    branches:
      - "main"
      - "staging"
      - "testing"
      - "github-action"
    paths:
      - "**/workflows/**"
      - "**/src/**"

env: 
  #ANDROID_NAME: Inspector.Android
  #ANDROID_BUILD_APK: x_do.gob.ogtic.reportero.apk
  #IOS_NAME: Inspector.iOS
  #IOS_BUILD_APK: do.gob.ogtic.Inspector.ipa
  #MONO_VERSION: '6.10'
  #ANDROID_VERSION: '11.1'
  BUILD_CONFIGURATION: Release-Agent
  SLN_FILE_PATH: './src/Inspector.sln'
  ANDROID_CSPROJ_FILE_PATH: './src/Inspector.Android/Inspector.Android.csproj'
  ANDROID_AGENTMANIFEST_FILE_PATH: './src/Inspector.Android/Properties/AndroidManifestAgent.xml'

jobs:
  build-reportero:
    if: github.head_ref == 'main' #|| github.ref == 'refs/heads/github-action'
    runs-on: macos-latest
    env: 
          APK_FILE_PATH: './src/Inspector.Android/bin/Release-Agent/x_do.gob.ogtic.reportero.apk'
          DISTRIBUTION_GROUP: 'Internal'
          APPCENTER_OWNER_APP: 'gobdo/Reportero-Ciudadano-Droid'

    steps:
        - name: Checkout repository and submodules
          uses: actions/checkout@v2
          with:
            submodules: 'recursive'
            token: ${{ secrets.INSPECTOR_PAT }}            

        - name: Create appsettings.json file
          uses: jsdaniell/create-json@1.1.2
          with:
            name: "appsettings.json"
            json: ${{ secrets.APP_SETTINGS }}
            dir: './src/Inspector/'

        - name: Restore NuGet packages
          run: nuget restore ${{ env.SLN_FILE_PATH }}

        - name: Build Android
          run: MSBuild /t:PackageForAndroid /p:Configuration=${{ env.BUILD_CONFIGURATION }} /p:AndroidPackageFormat=apk ${{ env.ANDROID_CSPROJ_FILE_PATH }}

        #- uses: actions/upload-artifact@v2
        #  with:
        #    name: android-apk
        #    path: "**/bin/${{ env.BUILD_CONFIGURATION }}/${{ env.ANDROID_BUILD_APK }}"
        #    if-no-files-found: error
        #    retention-days: 1

        - name: Setup App Center CLI
          run: npm install -g appcenter-cli
        
        - name: Upload Android app to App Center
          run: appcenter distribute release --silent --app ${{ env.APPCENTER_OWNER_APP }} --file ${{ env.APK_FILE_PATH }} --group "${{ env.DISTRIBUTION_GROUP }}" --token ${{ secrets.APP_CENTER_TOKEN }}

  build-reportero-testing:
    if: github.head_ref == 'testing' || github.ref == 'refs/heads/github-action'
    runs-on: macos-latest
    env: 
          PACKAGE_NAME: 'testing_do.gob.ogtic.reportero'
          DISTRIBUTION_GROUP: 'Internal'
          APPCENTER_OWNER_APP: 'Reportero-Testers-Droid'

    steps:
        - name: Set environment variables
          run: |
            echo "PACKAGE_FILE_NAME=${{ env.PACKAGE_NAME }}.apk" >> $GITHUB_ENV
            echo "PACKAGE_FILE_PATH=./src/Inspector.Android/bin/Release-Agent/${{ env.PACKAGE_NAME }}.apk" >> $GITHUB_ENV

        - name: Checkout repository and submodules
          uses: actions/checkout@v2
          with:
            submodules: 'recursive'
            token: ${{ secrets.INSPECTOR_PAT }}            

        - name: Create appsettings.json file
          uses: jsdaniell/create-json@1.1.2
          with:
            name: "appsettings.json"
            json: ${{ secrets.APP_SETTINGS }}
            dir: './src/Inspector/'

        - name: Restore NuGet packages
          run: nuget restore ${{ env.SLN_FILE_PATH }}

        #- name: Setup Android signing
        #  run: (echo ${{ secrets.KEYSTORE }} | base64 --decode) > ./src/Inspector.Android/keystore.jks

        - name: Set Android version
          uses: damienaicheh/update-android-version-manifest-action@v1.0.0
          with:
            android-manifest-path: ${{ env.ANDROID_AGENTMANIFEST_FILE_PATH }}
            version-name: ${{ secrets.APP_VERSION }}.${{ github.run_number }}
            version-code: ${{ github.run_number }}
            print-file: true

        - name: Set Android Package and App Name
          uses: damienaicheh/update-android-manifest-package-action@v1.0.0
          with:
            android-manifest-path: ${{ env.ANDROID_AGENTMANIFEST_FILE_PATH }}
            package-name: ${{ env.PACKAGE_FILE_NAME }}
            app-name: 'Reportero Testing'
            print-file: true

        - name: Build Android
          run: MSBuild /t:PackageForAndroid /p:Configuration=${{ env.BUILD_CONFIGURATION }} /p:AndroidPackageFormat=apk ${{ env.ANDROID_CSPROJ_FILE_PATH }}
          
        - name: Setup App Center CLI
          run: npm install -g appcenter-cli
        
        - name: Upload Android app to App Center
          run: appcenter distribute release --silent --app ${{ env.APPCENTER_OWNER_APP }} --file ${{ env.PACKAGE_FILE_PATH }} --group "${{ env.DISTRIBUTION_GROUP }}" --token ${{ secrets.APP_CENTER_TOKEN }}

  #build-ios:
  #  runs-on: macos-latest
  #  continue-on-error: true
  #  env:
  #    SLN_FILE_PATH: './src/Inspector.sln'
  #    CSPROJ_FILE_PATH: './src/Inspector.iOS/Inspector.iOS.csproj'
  #    IOS_VERSION: '14.10'

  #  steps:
  #  - uses: actions/checkout@v2
  #    with:
  #      submodules: 'recursive'
  #      token: ${{ secrets.OGTIC_PAT }}

  #  - name: Set default Xamarin SDK versions
  #    run: |
  #      $VM_ASSETS/select-xamarin-sdk-v2.sh --mono=${{ env.MONO_VERSION }} --ios=${{ env.IOS_VERSION }}

  #  - name: Set default Xcode 12.3
  #    run: |
  #      XCODE_ROOT=/Applications/Xcode_12.3.0.app
  #      echo "MD_APPLE_SDK_ROOT=$XCODE_ROOT" >> $GITHUB_ENV
  #      sudo xcode-select -s $XCODE_ROOT

  #  - uses: actions/setup-dotnet@v1
  #    with:
  #      dotnet-version: '3.1.x'

  #  - run: |
  #      nuget restore ${{ env.SLN_FILE_PATH }}
  #      msbuild /p:Platform=iPhoneSimulator /t:Rebuild /p:Configuration=${{ env.BUILD_CONFIGURATION }} /p:UseSharedCompilation=false ${{ env.CSPROJ_FILE_PATH }}

  #distribute-android:
  #  if: github.event_name == 'pull_request'
  #  runs-on: ubuntu-latest
  #  needs: [ build-android ]

  #  steps:
  #  - uses: actions/download-artifact@v2
  #    with:
  #      name: android-apk
  #      path: ./

  #  - name: Display structure of downloaded files
  #    run: ls -R

  #  - name: App Center
  #    uses: wzieba/AppCenter-Github-Action@v1.0.0
  #    with:
  #      appName: gobdo/Reportero-Ciudadano-Droid
  #      token: ${{ secrets.APP_CENTER_TOKEN }}
  #      group: Internal
  #      file: ./src/${{ env.ANDROID_NAME }}/bin/${{ env.BUILD_CONFIGURATION }}/${{ env.ANDROID_BUILD_APK }}
  #      releaseNotes: "github action test"
